name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64
          - target: aarch64-pc-windows-msvc
            arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri
            crates/wsl-core
          cache-on-failure: true
          key: ${{ matrix.target }}

      - name: Install npm dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VITE_APTABASE_KEY: ${{ secrets.VITE_APTABASE_KEY }}
        with:
          tagName: ${{ needs.release-please.outputs.tag_name }}
          releaseName: "WSL UI ${{ needs.release-please.outputs.tag_name }}"
          releaseBody: |
            See the [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ## Installation

            **Standard Installation:** Download the `.msi` installer below and run it.

            **Microsoft Store:** Also available on the [Microsoft Store](https://apps.microsoft.com/detail/9P8548KNJ2M9).
          releaseDraft: false
          prerelease: false
          includeDebug: false
          args: --target ${{ matrix.target }}

      - name: Generate store icons
        shell: pwsh
        run: .\scripts\generate-store-icons.ps1

      - name: Convert version to MSIX format
        id: msix-version
        shell: pwsh
        run: |
          # Convert semver tag to MSIX 4-part version (1.2.3.0)
          # Handles tags like "v1.2.3", "wsl-ui-v1.2.3", etc.
          $tag = "${{ needs.release-please.outputs.tag_name }}"
          # Extract just the version numbers (strips any prefix like "wsl-ui-v" or just "v")
          if ($tag -match '(\d+\.\d+\.\d+)') {
            $version = $matches[1]
          } else {
            Write-Host "ERROR: Could not extract version from tag: $tag"
            exit 1
          }
          $parts = $version.Split('.')
          # Ensure we have exactly 4 parts (MSIX requirement)
          while ($parts.Count -lt 4) {
            $parts += "0"
          }
          $msixVersion = ($parts[0..3]) -join '.'
          Write-Host "Tag: $tag -> MSIX Version: $msixVersion"
          "msix_version=$msixVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build MSIX package
        shell: pwsh
        run: |
          .\scripts\build-msix.ps1 -Version "${{ steps.msix-version.outputs.msix_version }}" -Architecture "${{ matrix.arch }}"

      - name: Prepare portable exe
        shell: pwsh
        run: |
          $version = "${{ steps.msix-version.outputs.msix_version }}".Split('.')[0..2] -join '.'
          $src = "src-tauri/target/${{ matrix.target }}/release/wsl-ui.exe"
          $dst = "dist/WSL.UI_${version}_${{ matrix.arch }}_portable.exe"
          Copy-Item $src $dst
          Write-Host "Created portable exe: $dst"

      - name: Upload MSIX and portable exe to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            dist/*.msix
            dist/*_portable.exe
