name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  # Unit tests - runs on all triggers
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:run

  # Rust tests - runs on all triggers (Windows required for winreg)
  rust-tests:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri
            crates/wsl-core
          cache-on-failure: true

      - name: Run Rust tests
        working-directory: src-tauri
        run: cargo test

      - name: Run wsl-core tests
        working-directory: crates/wsl-core
        run: cargo test

  # E2E tests - only runs on manual trigger with run_e2e=true
  e2e-tests:
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch' && inputs.run_e2e

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri
            crates/wsl-core
          cache-on-failure: true

      - name: Cache tauri-driver
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/tauri-driver.exe
          key: ${{ runner.os }}-tauri-driver-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-tauri-driver-

      - name: Install tauri-driver
        run: |
          if (!(Get-Command tauri-driver -ErrorAction SilentlyContinue)) {
            cargo install tauri-driver
          }
        shell: pwsh

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app (debug)
        run: npm run tauri build -- --debug --no-bundle
        env:
          TAURI_SIGNING_PRIVATE_KEY: ""
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""

      - name: Run E2E tests
        run: |
          # Start tauri-driver in background
          $driver = Start-Process -FilePath "tauri-driver" -PassThru -WindowStyle Hidden

          # Wait for driver to be ready
          Start-Sleep -Seconds 3

          try {
            # Run the tests
            npm run test:e2e
            $testExit = $LASTEXITCODE
          } finally {
            # Cleanup - always kill the driver
            Stop-Process -Id $driver.Id -Force -ErrorAction SilentlyContinue
          }

          exit $testExit
        shell: pwsh
        env:
          CI: true
          WSL_UI_MOCK_MODE: "true"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/
          if-no-files-found: ignore
          retention-days: 7

  # Summary job for branch protection - only checks required tests
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [unit-tests, rust-tests]
    if: always()
    steps:
      - name: Check required jobs passed
        run: |
          if [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.rust-tests.result }}" != "success" ]]; then
            echo "Required tests failed"
            exit 1
          fi
          echo "All required tests passed!"
