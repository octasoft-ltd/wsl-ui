# Manual release workflow - use this only for emergency releases or re-building a tag
# For normal releases, use conventional commits and release-please will handle it automatically
name: Manual Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to build (e.g., v1.0.0)"
        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64
          - target: aarch64-pc-windows-msvc
            arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri
            crates/wsl-core
          cache-on-failure: true
          key: ${{ matrix.target }}

      - name: Install npm dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VITE_APTABASE_KEY: ${{ secrets.VITE_APTABASE_KEY }}
        with:
          tagName: ${{ inputs.tag }}
          releaseName: "WSL UI ${{ inputs.tag }}"
          releaseBody: |
            See the [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ## Installation

            **Standard Installation:** Download the `.msi` installer below and run it.

            **Microsoft Store:** Also available on the [Microsoft Store](https://apps.microsoft.com/detail/9P8548KNJ2M9).
          releaseDraft: false
          prerelease: false
          includeDebug: false
          args: --target ${{ matrix.target }}

      - name: Generate store icons
        shell: pwsh
        run: .\scripts\generate-store-icons.ps1

      - name: Convert version to MSIX format
        id: msix-version
        shell: pwsh
        run: |
          # Convert semver tag (v1.2.3) to MSIX 4-part version (1.2.3.0)
          $tag = "${{ inputs.tag }}"
          $version = $tag -replace '^v', ''
          $parts = $version.Split('.')
          # Ensure we have exactly 4 parts (MSIX requirement)
          while ($parts.Count -lt 4) {
            $parts += "0"
          }
          $msixVersion = ($parts[0..3]) -join '.'
          Write-Host "MSIX Version: $msixVersion"
          "msix_version=$msixVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build MSIX package
        shell: pwsh
        run: |
          .\scripts\build-msix.ps1 -Version "${{ steps.msix-version.outputs.msix_version }}" -Architecture "${{ matrix.arch }}"

      - name: Prepare portable exe
        shell: pwsh
        run: |
          $version = "${{ steps.msix-version.outputs.msix_version }}".Split('.')[0..2] -join '.'
          $src = "src-tauri/target/${{ matrix.target }}/release/wsl-ui.exe"
          $dst = "dist/WSL.UI_${version}_${{ matrix.arch }}_portable.exe"
          Copy-Item $src $dst
          Write-Host "Created portable exe: $dst"

      - name: Upload MSIX and portable exe to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          files: |
            dist/*.msix
            dist/*_portable.exe
